<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SAGE Fees Analyzer - 24h</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #0a0e27;
      color: #e0e0e0;
      padding: 20px;
      line-height: 1.6;
    }
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    h1 {
      text-align: center;
      color: #00d4ff;
      text-shadow: 0 0 10px rgba(0, 212, 255, 0.5);
      margin-bottom: 40px;
    }
    .examples-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    .example-card {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .example-card:hover {
      border-color: #00d4ff;
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.3);
      transform: translateY(-5px);
    }
    .example-card.active {
      border-color: #00d4ff;
      background: rgba(0, 212, 255, 0.1);
    }
    .example-card h3 {
      margin-top: 0;
      color: #00d4ff;
    }
    .example-card p {
      margin-bottom: 0;
      color: #ccc;
      font-size: 14px;
    }
    .form-container {
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 10px;
      padding: 30px;
      display: none;
      margin-bottom: 30px;
    }
    .form-container.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .form-container h2 {
      margin-top: 0;
      color: #00d4ff;
      border-bottom: 2px solid rgba(0, 212, 255, 0.3);
      padding-bottom: 10px;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      color: #00d4ff;
      font-weight: 500;
    }
    input[type="text"],
    input[type="number"] {
      width: 100%;
      padding: 10px;
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 5px;
      background: rgba(0, 0, 0, 0.3);
      color: #fff;
      font-size: 14px;
      box-sizing: border-box;
    }
    input[type="text"]:focus,
    input[type="number"]:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 10px rgba(0, 212, 255, 0.3);
    }
    button {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #fff;
      border: none;
      padding: 12px 30px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 16px;
      font-weight: 600;
      transition: all 0.3s ease;
      width: 100%;
      margin-top: 10px;
    }
    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 212, 255, 0.4);
    }
    button:active {
      transform: translateY(0);
    }
    button:disabled {
      background: #555;
      cursor: not-allowed;
      transform: none;
    }
    .result-container {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 10px;
      padding: 20px;
      margin-top: 20px;
      display: none;
    }
    .result-container.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    .result-container h3 {
      margin-top: 0;
      color: #00d4ff;
    }
    pre {
      background: rgba(0, 0, 0, 0.5);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 5px;
      padding: 15px;
      overflow-x: auto;
      color: #0f0;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      line-height: 1.5;
    }
    .error {
      color: #ff4444;
      background: rgba(255, 68, 68, 0.1);
      border: 1px solid #ff4444;
      border-radius: 5px;
      padding: 15px;
      margin-top: 20px;
    }
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(0, 212, 255, 0.3);
      border-radius: 50%;
      border-top-color: #00d4ff;
      animation: spin 1s ease-in-out infinite;
      margin-left: 10px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .info-text {
      background: rgba(0, 212, 255, 0.1);
      border-left: 4px solid #00d4ff;
      padding: 10px 15px;
      margin-bottom: 20px;
      border-radius: 3px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: rgba(0, 0, 0, 0.3);
      border-radius: 5px;
      overflow: hidden;
    }
    thead {
      background: rgba(0, 212, 255, 0.2);
    }
    th, td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    th {
      color: #00d4ff;
      font-weight: 600;
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    td {
      color: #eee;
      font-size: 13px;
    }
    tbody tr:hover {
      background: rgba(0, 212, 255, 0.1);
    }
    .fleet-stat {
      display: inline-block;
      margin: 2px 5px 2px 0;
      padding: 3px 8px;
      background: rgba(0, 212, 255, 0.15);
      border-radius: 3px;
      font-size: 11px;
    }
    .ship-count {
      font-weight: 600;
      color: #00d4ff;
    }
    details {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 5px;
      padding: 10px;
      cursor: pointer;
    }
    details summary {
      font-weight: 600;
      padding: 5px;
    }
    details[open] summary {
      margin-bottom: 15px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    .tx-button {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #fff;
      border: none;
      padding: 6px 12px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      margin-top: 5px;
    }
    .tx-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(0, 212, 255, 0.4);
    }
    .tx-table {
      margin-top: 20px;
    }
    .tx-table th {
      background: rgba(0, 212, 255, 0.15);
    }
    .tx-success {
      color: #0f0;
      font-weight: 600;
    }
    .tx-failed {
      color: #f44;
      font-weight: 600;
    }
    .tx-signature {
      font-family: 'Courier New', monospace;
      font-size: 11px;
      color: #00d4ff;
      cursor: pointer;
    }
    .tx-signature:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <h1>‚≠ê Star Atlas SAGE Toolkit</h1>
  
  <div class="examples-grid">
    <div class="example-card" data-example="game">
      <h3>üìä Game Info</h3>
      <p>Visualizza informazioni sul gioco SAGE: risorse, categorie, fazioni e zone di rischio</p>
    </div>
    
    <div class="example-card" data-example="profile">
      <h3>üë§ Player Profile</h3>
      <p>Cerca un profilo giocatore tramite Wallet Public Key</p>
    </div>
    
    <div class="example-card" data-example="fleets">
      <h3>üöÄ Fleets</h3>
      <p>Visualizza tutte le flotte associate a un profilo giocatore</p>
    </div>
    
    <div class="example-card" data-example="wallet-fees">
      <h3>üí∞ Wallet SAGE Fees</h3>
      <p>Analizza le fee pagate dal tuo wallet per operazioni SAGE con le flotte</p>
    </div>
    
    <div class="example-card" data-example="planets">
      <h3>ü™ê Planets</h3>
      <p>Cerca pianeti e risorse minerarie tramite coordinate X/Y</p>
    </div>
    
    <div class="example-card" data-example="compose">
      <h3>‚öôÔ∏è Compose Fleet</h3>
      <p>Elenca navi disponibili per la composizione della flotta presso una starbase</p>
    </div>
  </div>

  <!-- Game Info Form -->
  <div id="form-game" class="form-container">
    <h2>üìä Game Info</h2>
    <div class="info-text">
      Questo endpoint recupera le informazioni di configurazione del gioco SAGE, incluse le categorie di risorse, mint token, vault e zone di rischio.
    </div>
    <button onclick="fetchGameInfo()">Carica Informazioni Gioco</button>
    <div id="result-game" class="result-container"></div>
  </div>

  <!-- Player Profile Form -->
  <div id="form-profile" class="form-container">
    <h2>üë§ Player Profile</h2>
    <div class="info-text">
      Inserisci la <strong>Wallet Public Key</strong> del giocatore per cercare i suoi profili su SAGE.
    </div>
    <form onsubmit="fetchPlayerProfile(event)">
      <div class="form-group">
        <label>Wallet Public Key</label>
        <input type="text" id="profileId" placeholder="Es: 7sZFMdaGCATXsJuWfj19ExnLt9P7RVm4Bykmvz2Jrh5x" required>
      </div>
      <button type="submit">Cerca Profilo</button>
    </form>
    <div id="result-profile" class="result-container"></div>
  </div>

  <!-- Fleets Form -->
  <div id="form-fleets" class="form-container">
    <h2>üöÄ Fleets</h2>
    <div class="info-text">
      Inserisci il <strong>Player Profile ID</strong> (non la wallet) per visualizzare tutte le flotte associate.
    </div>
    <form onsubmit="fetchFleets(event)">
      <div class="form-group">
        <label>Player Profile ID</label>
        <input type="text" id="fleetsProfileId" placeholder="Your Player Profile ID" required>
      </div>
      <button type="submit">Cerca Flotte</button>
    </form>
    <div id="result-fleets" class="result-container"></div>
  </div>

  <!-- Wallet SAGE Fees Form -->
  <div id="form-wallet-fees" class="form-container">
    <h2>üí∞ Wallet SAGE Fees</h2>
    <div class="info-text">
      Inserisci il <strong>Player Profile ID</strong> per analizzare tutte le fee pagate per operazioni SAGE con le tue flotte.
    </div>
    <form onsubmit="fetchWalletSageFees(event)">
      <div class="form-group">
        <label>Player Profile ID</label>
        <input type="text" id="walletFeesKey" placeholder="Your Player Profile ID" required>
      </div>
      <div class="form-group">
        <label>Limite transazioni (opzionale)</label>
        <input type="number" id="walletFeesLimit" placeholder="100" value="100">
      </div>
      <button type="submit">Analizza Fee SAGE</button>
      <button type="button" onclick="fetchWalletSageFeesDetailed()" style="margin-top: 10px; background: linear-gradient(135deg, #ff9500 0%, #ff6b00 100%);">üìä Analisi 24h Dettagliata (per Flotta & Operazione)</button>
    </form>
    <div id="result-wallet-fees" class="result-container"></div>
  </div>

  <!-- Planets Form -->
  <div id="form-planets" class="form-container">
    <h2>ü™ê Planets</h2>
    <div class="info-text">
      Inserisci le coordinate X e Y per cercare pianeti e risorse minerarie.
    </div>
    <form onsubmit="fetchPlanets(event)">
      <div class="form-group">
        <label>Coordinata X</label>
        <input type="number" id="planetX" placeholder="Es: -39" required>
      </div>
      <div class="form-group">
        <label>Coordinata Y</label>
        <input type="number" id="planetY" placeholder="Es: 36" required>
      </div>
      <button type="submit">Cerca Pianeti</button>
    </form>
    <div id="result-planets" class="result-container"></div>
  </div>

  <!-- Compose Fleet Form -->
  <div id="form-compose" class="form-container">
    <h2>‚öôÔ∏è Compose Fleet</h2>
    <div class="info-text">
      Inserisci il Profile ID e le coordinate della starbase per visualizzare le navi disponibili per la composizione della flotta.
    </div>
    <form onsubmit="fetchComposeFleet(event)">
      <div class="form-group">
        <label>Profile ID (PublicKey)</label>
        <input type="text" id="composeProfileId" placeholder="Es: 5Ls9V..." required>
      </div>
      <div class="form-group">
        <label>Coordinata X Starbase</label>
        <input type="number" id="composeX" placeholder="Es: -39" required>
      </div>
      <div class="form-group">
        <label>Coordinata Y Starbase</label>
        <input type="number" id="composeY" placeholder="Es: 36" required>
      </div>
      <button type="submit">Cerca Navi Disponibili</button>
    </form>
    <div id="result-compose" class="result-container"></div>
  </div>

  <script>
    // Navigation
    document.querySelectorAll('.example-card').forEach(card => {
      card.addEventListener('click', function() {
        const example = this.dataset.example;
        
        // Reset all cards and forms
        document.querySelectorAll('.example-card').forEach(c => c.classList.remove('active'));
        document.querySelectorAll('.form-container').forEach(f => f.classList.remove('active'));
        document.querySelectorAll('.result-container').forEach(r => r.classList.remove('active'));
        
        // Activate selected
        this.classList.add('active');
        document.getElementById(`form-${example}`).classList.add('active');
      });
    });

    // API Calls
    async function fetchGameInfo() {
      const resultDiv = document.getElementById('result-game');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento<span class="loading"></span></h3>';
      
      try {
        const response = await fetch('/api/game');
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante il caricamento');
        }
        
        resultDiv.innerHTML = `
          <h3>‚úÖ Risultato</h3>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function fetchPlayerProfile(event) {
      event.preventDefault();
      const profileId = document.getElementById('profileId').value;
      const resultDiv = document.getElementById('result-profile');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento<span class="loading"></span></h3>';
      
      try {
        const response = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileId })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante la ricerca');
        }
        
        resultDiv.innerHTML = `
          <h3>‚úÖ Risultato (${data.length} profili trovati)</h3>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function fetchFleets(event) {
      event.preventDefault();
      const profileId = document.getElementById('fleetsProfileId').value;
      const resultDiv = document.getElementById('result-fleets');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento<span class="loading"></span></h3>';
      
      try {
        const response = await fetch('/api/fleets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileId })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante la ricerca');
        }
        
        // Create table HTML
        let tableHTML = `
          <h3>‚úÖ Risultato (${data.length} flotte trovate)</h3>
          <table>
            <thead>
              <tr>
                <th>Callsign</th>
                <th>Navi</th>
                <th>Movimento</th>
                <th>Cargo</th>
                <th>Equipaggio</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.forEach(fleet => {
          const stats = fleet.data.stats;
          const ships = fleet.data.shipCounts;
          const misc = stats.miscStats;
          const fleetShipsAccount = fleet.data.fleetShips;
          
          tableHTML += `
            <tr>
              <td>
                <strong>${fleet.callsign}</strong><br>
                <button class="tx-button" onclick="viewTransactions('${fleetShipsAccount}', '${fleet.callsign}')">üìú Transazioni</button>
              </td>
              <td>
                <span class="ship-count">${ships.total}</span> navi<br>
                ${ships.xxSmall > 0 ? `<span class="fleet-stat">XX-Small: ${ships.xxSmall}</span>` : ''}
                ${ships.xSmall > 0 ? `<span class="fleet-stat">X-Small: ${ships.xSmall}</span>` : ''}
                ${ships.small > 0 ? `<span class="fleet-stat">Small: ${ships.small}</span>` : ''}
                ${ships.medium > 0 ? `<span class="fleet-stat">Medium: ${ships.medium}</span>` : ''}
                ${ships.large > 0 ? `<span class="fleet-stat">Large: ${ships.large}</span>` : ''}
              </td>
              <td>
                <span class="fleet-stat">üöÄ ${stats.movementStats.subwarpSpeed}</span><br>
                <span class="fleet-stat">‚ö° Warp: ${stats.movementStats.maxWarpDistance}</span><br>
                <span class="fleet-stat">‚è±Ô∏è Cooldown: ${stats.movementStats.warpCoolDown}s</span>
              </td>
              <td>
                <span class="fleet-stat">üì¶ ${stats.cargoStats.cargoCapacity}</span><br>
                <span class="fleet-stat">‚õΩ ${stats.cargoStats.fuelCapacity}</span><br>
                <span class="fleet-stat">üí£ ${stats.cargoStats.ammoCapacity}</span>
              </td>
              <td>
                <span class="fleet-stat">üë• ${misc.crewCount}/${misc.requiredCrew}</span><br>
                <span class="fleet-stat">‚è±Ô∏è Respawn: ${misc.respawnTime}s</span><br>
                <span class="fleet-stat">üîç Scan: ${misc.scanCoolDown}s</span>
              </td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
          <details style="margin-top: 20px;">
            <summary style="cursor: pointer; color: #00d4ff; margin-bottom: 10px;">üìã Mostra JSON completo</summary>
            <pre>${JSON.stringify(data, null, 2)}</pre>
          </details>
        `;
        
        resultDiv.innerHTML = tableHTML;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function fetchPlanets(event) {
      event.preventDefault();
      const x = parseInt(document.getElementById('planetX').value);
      const y = parseInt(document.getElementById('planetY').value);
      const resultDiv = document.getElementById('result-planets');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento<span class="loading"></span></h3>';
      
      try {
        const response = await fetch('/api/planets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ x, y })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante la ricerca');
        }
        
        resultDiv.innerHTML = `
          <h3>‚úÖ Risultato (${data.length} pianeti trovati)</h3>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function fetchComposeFleet(event) {
      event.preventDefault();
      const profileId = document.getElementById('composeProfileId').value;
      const x = parseInt(document.getElementById('composeX').value);
      const y = parseInt(document.getElementById('composeY').value);
      const resultDiv = document.getElementById('result-compose');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento<span class="loading"></span></h3>';
      
      try {
        const response = await fetch('/api/compose-fleet', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileId, x, y })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante la ricerca');
        }
        
        resultDiv.innerHTML = `
          <h3>‚úÖ Risultato (${data.length} navi trovate)</h3>
          <pre>${JSON.stringify(data, null, 2)}</pre>
        `;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function viewTransactions(accountPubkey, fleetName) {
      const resultDiv = document.getElementById('result-fleets');
      resultDiv.innerHTML = `<h3>Caricamento transazioni per ${fleetName}<span class="loading"></span></h3>`;
      
      try {
        const response = await fetch('/api/transactions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ accountPubkey, limit: 50 })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante il caricamento');
        }
        
        let txHTML = `
          <h3>üìú Transazioni per: <strong>${fleetName}</strong></h3>
          <p style="color: #aaa; font-size: 14px;">Account: <span class="tx-signature" onclick="window.open('https://solscan.io/account/${accountPubkey}', '_blank')">${accountPubkey}</span></p>
          <p>Totale transazioni: <strong>${data.totalTransactions}</strong></p>
          <button onclick="location.reload()" style="margin-bottom: 20px;">‚Üê Torna alle flotte</button>
          <table class="tx-table">
            <thead>
              <tr>
                <th>Data/Ora</th>
                <th>Signature</th>
                <th>Status</th>
                <th>Fee (SOL)</th>
                <th>Programs</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.transactions.forEach(tx => {
          const date = new Date(tx.timestamp).toLocaleString('it-IT');
          const shortSig = tx.signature.substring(0, 8) + '...' + tx.signature.substring(tx.signature.length - 8);
          const feeSOL = (tx.fee / 1e9).toFixed(6);
          
          txHTML += `
            <tr>
              <td>${date}</td>
              <td>
                <span class="tx-signature" onclick="window.open('https://solscan.io/tx/${tx.signature}', '_blank')" title="${tx.signature}">
                  ${shortSig}
                </span>
              </td>
              <td class="${tx.status === 'success' ? 'tx-success' : 'tx-failed'}">
                ${tx.status === 'success' ? '‚úÖ Success' : '‚ùå Failed'}
              </td>
              <td>${feeSOL}</td>
              <td style="font-size: 11px;">
                ${tx.programIds.map(id => {
                  const shortId = id.substring(0, 6) + '...';
                  return `<span class="fleet-stat" title="${id}">${shortId}</span>`;
                }).join(' ')}
              </td>
            </tr>
          `;
        });
        
        txHTML += `
            </tbody>
          </table>
        `;
        
        resultDiv.innerHTML = txHTML;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
          <button onclick="location.reload()" style="margin-top: 15px;">‚Üê Torna alle flotte</button>
        `;
      }
    }

    async function fetchWalletSageFees(event) {
      event.preventDefault();
      const profileId = document.getElementById('walletFeesKey').value;
      const limit = parseInt(document.getElementById('walletFeesLimit').value) || 100;
      const resultDiv = document.getElementById('result-wallet-fees');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento<span class="loading"></span></h3>';
      
      try {
        // First get profile to find wallet
        const profileResponse = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileId })
        });
        
        if (!profileResponse.ok) {
          throw new Error('Errore nel recupero del profilo');
        }
        
        const profiles = await profileResponse.json();
        if (profiles.length === 0) {
          throw new Error('Nessun profilo trovato per questo ID');
        }
        
        const walletPubkey = '7sZFMdaGCATXsJuWfj19ExnLt9P7RVm4Bykmvz2Jrh5x'; // Your wallet
        
        const response = await fetch('/api/wallet-sage-fees', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ walletPubkey, limit })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante l\'analisi');
        }
        
        // Summary
        let html = `
          <h3>üí∞ Analisi Fee SAGE</h3>
          <p style="color: #aaa; font-size: 14px;">Wallet: <span class="tx-signature" onclick="window.open('https://solscan.io/account/${data.walletAddress}', '_blank')">${data.walletAddress}</span></p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
              <div style="font-size: 12px; color: #aaa;">Transazioni Totali</div>
              <div style="font-size: 24px; font-weight: 600; color: #00d4ff;">${data.totalTransactions}</div>
            </div>
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
              <div style="font-size: 12px; color: #aaa;">Transazioni SAGE</div>
              <div style="font-size: 24px; font-weight: 600; color: #00d4ff;">${data.sageTransactions}</div>
            </div>
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
              <div style="font-size: 12px; color: #aaa;">Fee Totali</div>
              <div style="font-size: 24px; font-weight: 600; color: #00d4ff;">${(data.totalFees / 1e9).toFixed(6)} SOL</div>
            </div>
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
              <div style="font-size: 12px; color: #aaa;">Fee SAGE</div>
              <div style="font-size: 24px; font-weight: 600; color: #0f0;">${(data.totalSageFees / 1e9).toFixed(6)} SOL</div>
            </div>
          </div>

          <h4 style="color: #00d4ff; margin-top: 30px;">üìä Fee per Programma</h4>
          <table>
            <thead>
              <tr>
                <th>Program ID</th>
                <th>Transazioni</th>
                <th>Fee Totali (SOL)</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        // Sort by fee
        const sortedPrograms = Object.entries(data.feesByProgram).sort((a, b) => b[1].totalFee - a[1].totalFee);
        
        sortedPrograms.forEach(([programId, stats]) => {
          const isSage = programId === 'SAGE2HAwep459SNq61LHvjxPk4pLPEJLoMETef7f7EE';
          const shortId = programId.substring(0, 8) + '...' + programId.substring(programId.length - 8);
          
          html += `
            <tr style="${isSage ? 'background: rgba(0, 255, 0, 0.05);' : ''}">
              <td>
                <span class="tx-signature" onclick="window.open('https://solscan.io/account/${programId}', '_blank')" title="${programId}">
                  ${shortId}
                </span>
                ${isSage ? ' <span style="color: #0f0; font-weight: 600;">‚≠ê SAGE</span>' : ''}
              </td>
              <td>${stats.count}</td>
              <td style="font-weight: 600; color: ${isSage ? '#0f0' : '#00d4ff'};">${(stats.totalFee / 1e9).toFixed(6)}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>

          <h4 style="color: #00d4ff; margin-top: 30px;">üìú Ultime Transazioni SAGE</h4>
          <table class="tx-table">
            <thead>
              <tr>
                <th>Data/Ora</th>
                <th>Signature</th>
                <th>Status</th>
                <th>Fee (SOL)</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        data.transactions.slice(0, 20).forEach(tx => {
          const date = new Date(tx.timestamp).toLocaleString('it-IT');
          const shortSig = tx.signature.substring(0, 8) + '...' + tx.signature.substring(tx.signature.length - 8);
          const feeSOL = (tx.fee / 1e9).toFixed(6);
          
          html += `
            <tr>
              <td>${date}</td>
              <td>
                <span class="tx-signature" onclick="window.open('https://solscan.io/tx/${tx.signature}', '_blank')" title="${tx.signature}">
                  ${shortSig}
                </span>
              </td>
              <td class="${tx.status === 'success' ? 'tx-success' : 'tx-failed'}">
                ${tx.status === 'success' ? '‚úÖ Success' : '‚ùå Failed'}
              </td>
              <td>${feeSOL}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>
        `;
        
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }

    async function fetchWalletSageFeesDetailed() {
      console.log('fetchWalletSageFeesDetailed called');
      
      const profileId = document.getElementById('walletFeesKey').value;
      if (!profileId) {
        alert('Inserisci un Player Profile ID prima!');
        return;
      }

      console.log('Profile ID:', profileId);

      const resultDiv = document.getElementById('result-wallet-fees');
      resultDiv.classList.add('active');
      resultDiv.innerHTML = '<h3>Caricamento analisi dettagliata 24h<span class="loading"></span></h3><p style="color: #aaa;">Questo potrebbe richiedere alcuni minuti per analizzare tutte le transazioni...</p>';
      
      try {
        console.log('Fetching profile info...');
        // Get profile details to find the wallet
        const profileResponse = await fetch('/api/profile', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileId })
        });
        
        console.log('Profile response status:', profileResponse.status);
        
        if (!profileResponse.ok) {
          const errorData = await profileResponse.json();
          throw new Error(errorData.error || 'Errore nel recupero del profilo');
        }
        
        const profiles = await profileResponse.json();
        if (profiles.length === 0) {
          throw new Error('Nessun profilo trovato per questo ID');
        }
        
        const profile = profiles[0];
        // Use the wallet from the server config instead of profile authority
        // This matches the pattern used in the cookbook examples
        const walletPubkey = '7sZFMdaGCATXsJuWfj19ExnLt9P7RVm4Bykmvz2Jrh5x'; // Your wallet
        console.log('Using wallet from config:', walletPubkey);
        
        // Get fleets for this profile
        const fleetsResponse = await fetch('/api/fleets', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ profileId })
        });
        
        if (!fleetsResponse.ok) {
          throw new Error('Errore nel recupero delle flotte');
        }
        
        const fleets = await fleetsResponse.json();
        const fleetAccounts = fleets.map(f => f.data.fleetShips);
        
        console.log('Fleet accounts:', fleetAccounts);
        console.log('Fleet names:', fleets.map(f => f.callsign));
        
        // Debug: log full fleet structure to understand what accounts to use
        console.log('Full fleet structure (first fleet):', fleets[0]);
        
        // Try to collect ALL fleet-related accounts including fuel, ammo, cargo
        const allFleetAccounts = [];
        fleets.forEach(f => {
          // Main fleet accounts
          allFleetAccounts.push(f.data.fleetShips);  // Current approach
          allFleetAccounts.push(f.key);             // Fleet account key
          if (f.data.fleetState) allFleetAccounts.push(f.data.fleetState); // Fleet state
          
          // IMPORTANT: Add fuel, ammo, and cargo accounts!
          if (f.data.fuelTank) allFleetAccounts.push(f.data.fuelTank);
          if (f.data.ammoBank) allFleetAccounts.push(f.data.ammoBank);
          if (f.data.cargoHold) allFleetAccounts.push(f.data.cargoHold);
          
          // Add ship accounts if available
          if (f.data.ships && Array.isArray(f.data.ships)) {
            f.data.ships.forEach(ship => {
              if (typeof ship === 'string' && ship.length > 40) {
                allFleetAccounts.push(ship);
              }
            });
          }
          
          // Add any other relevant accounts from fleet data
          Object.keys(f.data).forEach(key => {
            if (typeof f.data[key] === 'string' && f.data[key].length > 40) {
              allFleetAccounts.push(f.data[key]);
            }
          });
        });
        
        const uniqueFleetAccounts = [...new Set(allFleetAccounts)];
        console.log('Enhanced fleet accounts (fuel/ammo/cargo):', uniqueFleetAccounts.length, uniqueFleetAccounts.slice(0, 15));
        
        // Create fleet name mapping for all possible accounts including fuel/ammo/cargo BEFORE using it
        const fleetNames = {};
        fleets.forEach(f => {
          // Map main accounts
          fleetNames[f.data.fleetShips] = f.callsign;
          fleetNames[f.key] = f.callsign;
          if (f.data.fleetState) fleetNames[f.data.fleetState] = f.callsign;
          
          // Map fuel, ammo, and cargo accounts specifically
          if (f.data.fuelTank) fleetNames[f.data.fuelTank] = f.callsign;
          if (f.data.ammoBank) fleetNames[f.data.ammoBank] = f.callsign;
          if (f.data.cargoHold) fleetNames[f.data.cargoHold] = f.callsign;
          
          // Map ship accounts
          if (f.data.ships && Array.isArray(f.data.ships)) {
            f.data.ships.forEach(ship => {
              if (typeof ship === 'string' && ship.length > 40) {
                fleetNames[ship] = f.callsign;
              }
            });
          }
          
          // Add other account mappings
          Object.keys(f.data).forEach(key => {
            if (typeof f.data[key] === 'string' && f.data[key].length > 40) {
              fleetNames[f.data[key]] = f.callsign;
            }
          });
        });
        
        // Now get detailed fees using all possible fleet accounts
        const response = await fetch('/api/wallet-sage-fees-detailed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            walletPubkey, 
            fleetAccounts: uniqueFleetAccounts, 
            fleetNames: fleetNames,  // Pass the mapping
            hours: 24 
          })
        });
        const data = await response.json();
        
        if (!response.ok) {
          throw new Error(data.error || 'Errore durante l\'analisi');
        }
        
        // Display results (fleetNames already created above)
        
        // Build HTML
        let html = `
          <h3>üìä Analisi Fee SAGE - Ultime 24 Ore</h3>
          <p style="color: #aaa; font-size: 14px;">Wallet: <span class="tx-signature" onclick="window.open('https://solscan.io/account/${data.walletAddress}', '_blank')">${data.walletAddress}</span></p>
          
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
            <div style="background: rgba(0, 212, 255, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 212, 255, 0.3);">
              <div style="font-size: 12px; color: #aaa;">Transazioni 24h</div>
              <div style="font-size: 24px; font-weight: 600; color: #00d4ff;">${data.transactionCount24h}</div>
            </div>
            <div style="background: rgba(0, 255, 0, 0.1); padding: 15px; border-radius: 8px; border: 1px solid rgba(0, 255, 0, 0.3);">
              <div style="font-size: 12px; color: #aaa;">Fee SAGE 24h</div>
              <div style="font-size: 24px; font-weight: 600; color: #0f0;">${(data.sageFees24h / 1e9).toFixed(6)} SOL</div>
            </div>
          </div>

          <h4 style="color: #00d4ff; margin-top: 30px;">üöÄ Fee per Flotta</h4>
          <table>
            <thead>
              <tr>
                <th>Flotta</th>
                <th>Fee Totali (SOL)</th>
                <th>% Wallet SAGE</th>
                <th>Top Operazioni</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        Object.entries(data.feesByFleet).forEach(([fleetAccount, fleetData]) => {
          const fleetName = fleetNames[fleetAccount] || fleetAccount.substring(0, 8) + '...';
          const sortedOps = Object.entries(fleetData.operations).sort((a,b) => b[1].totalFee - a[1].totalFee).slice(0,4);
          const operations = sortedOps.map(([op, stats]) => `${op} ${(stats.totalFee/1e9).toFixed(4)} SOL ${(stats.percentageOfFleet*100).toFixed(1)}%`).join('<br>');
          
          html += `
            <tr>
              <td><strong>${fleetName}</strong></td>
              <td style="color: #0f0; font-weight: 600;">${(fleetData.totalFee / 1e9).toFixed(6)}</td>
              <td style="color: #00d4ff; font-weight: 600;">${(fleetData.feePercentage*100).toFixed(2)}%</td>
              <td style="font-size: 11px; line-height: 1.3;">${operations || '‚Äî'}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>

          <h4 style="color: #00d4ff; margin-top: 30px;">üì¶ Dettaglio Operazioni per Flotta</h4>
        `;

        Object.entries(data.feesByFleet).forEach(([fleetAccount, fleetData]) => {
          const fleetName = fleetNames[fleetAccount] || fleetAccount.substring(0, 8) + '...';
          html += `
            <h5 style="color:#fff; margin-top:20px;">üöÄ ${fleetName} <span style="color:#00d4ff; font-size:12px;">(${(fleetData.totalFee/1e9).toFixed(5)} SOL - ${(fleetData.feePercentage*100).toFixed(2)}%)</span></h5>
            <table style="margin-bottom:10px;">
              <thead><tr><th>Operazione</th><th>Conteggio</th><th>Fee (SOL)</th><th>% Flotta</th><th>Fee Media</th></tr></thead>
              <tbody>
          `;
          Object.entries(fleetData.operations).sort((a,b)=> b[1].totalFee - a[1].totalFee).forEach(([op, stats]) => {
            html += `
              <tr>
                <td>${op}</td>
                <td>${stats.count}</td>
                <td style="color:#0f0;">${(stats.totalFee/1e9).toFixed(6)}</td>
                <td>${(stats.percentageOfFleet*100).toFixed(2)}%</td>
                <td>${(stats.avgFee/1e9).toFixed(6)}</td>
              </tr>
            `;
          });
          html += `</tbody></table>`;
        });
        
        html += `
          <h4 style="color: #00d4ff; margin-top: 30px;">‚öôÔ∏è Fee per Tipo di Operazione</h4>
          <table>
            <thead>
              <tr>
                <th>Operazione</th>
                <th>Conteggio</th>
                <th>Fee Totali (SOL)</th>
                <th>Fee Media (SOL)</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        const sortedOps = Object.entries(data.feesByOperation).sort((a, b) => b[1].totalFee - a[1].totalFee);
        
        sortedOps.forEach(([operation, stats]) => {
          html += `
            <tr>
              <td><strong>${operation}</strong></td>
              <td>${stats.count}</td>
              <td style="color: #0f0; font-weight: 600;">${(stats.totalFee / 1e9).toFixed(6)}</td>
              <td style="color: #00d4ff;">${(stats.avgFee / 1e9).toFixed(6)}</td>
            </tr>
          `;
        });
        
        html += `
            </tbody>
          </table>

          <h4 style="color: #00d4ff; margin-top: 30px;">ÔøΩ Riepilogo Operazioni (Globale)</h4>
          <p style="color:#aaa; font-size:12px;">Operazioni Sconosciute: ${data.unknownOperations}</p>
        `;
        
        resultDiv.innerHTML = html;
      } catch (error) {
        resultDiv.innerHTML = `
          <div class="error">
            <strong>‚ùå Errore:</strong> ${error.message}
          </div>
        `;
      }
    }
  </script>
</body>
</html>
